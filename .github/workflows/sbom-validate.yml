name: Validate SBOM (CycloneDX)

on:
  workflow_run:
    workflows: ["Generate SBOM"]
    types:
      - completed

jobs:
  validate:
    runs-on: ubuntu-latest

    permissions:
      actions: read        # âœ… éœ€è¦ actions:read æ‰èƒ½è®€å–å‰ä¸€å€‹ run çš„ artifact
      contents: read

    steps:
      - name: Download SBOM artifact from previous workflow
        uses: actions/download-artifact@v4
        with:
          name: server-template-sbom-spdx
          path: ./sbom
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}

      - name: Install CycloneDX CLI
        run: |
          curl -L -o cyclonedx \
            https://github.com/CycloneDX/cyclonedx-cli/releases/latest/download/cyclonedx-linux-x64
          chmod +x cyclonedx
          sudo mv cyclonedx /usr/local/bin/cyclonedx

      # - name: Validate SPDX JSON structure
      #   run: |
      #     echo "ğŸ§¾ Checking SPDX JSON validity..."
      #     cat ./sbom/new-vision-server.spdx.json | jq empty
    
      - name: Validate SBOM file
        run: |
          cyclonedx validate \
            --input-file ./sbom/server-template.cyclonedx.json \
            --input-format json \
            --fail-on-errors

      # 4ï¸âƒ£ ä¸Šå‚³é©—è­‰å¾Œçš„ SBOM çµ¦ä¸‹ä¸€å€‹ workflow ä½¿ç”¨
      - name: Upload validated SBOM artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: server-template-sbom-validated    # ğŸ‘ˆ çµ¦ä¸‹ä¸€æ­¥ Trivy ç”¨çš„ artifact åç¨±
          path: ./sbom/server-template.cyclonedx.json

