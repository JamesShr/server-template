# ==== BUILD STAGE ====
ARG BASE_VERSION
FROM jamesshi/nx-base:${BASE_VERSION} AS builder

WORKDIR /workspace

# ğŸš« é—œé–‰ Nx daemonã€äº’å‹•æ¨¡å¼èˆ‡ spinner
ENV NX_DAEMON=false
ENV NX_SKIP_NX_CACHE=true
ENV CI=true
ENV NODE_OPTIONS="--max-old-space-size=4096"

# # copy app source
# COPY apps/api-gateway ./apps/api-gateway

# RUN npm ci

# Build specific app (api-gateway)
RUN npx nx build api-gateway

# # æ··æ·† ./dist -> ./dist-obf
# RUN npx javascript-obfuscator ./apps/api-gateway/dist --output ./apps/api-gateway/dist-obf \
#   --compact true \
#   --control-flow-flattening true \
#   --string-array true \
#   --string-array-encoding base64


# ==== RUNTIME DEPS STAGE ====
FROM jamesshi/nx-base:${BASE_VERSION} AS deps

WORKDIR /app

# å¾ builder è¤‡è£½ä¿®å‰ªå¾Œçš„ package.jsonï¼ˆNx prune æœƒè¼¸å‡ºåˆ° dist ä¸‹ï¼‰
COPY --from=builder /workspace/apps/api-gateway/dist/package*.json ./

# åªå®‰è£ runtime deps
RUN npm ci --omit=dev


# ==== FINAL RUNTIME STAGE ====
FROM node:22.17.1-alpine AS runner

WORKDIR /app

# å®‰è£ä¸€äº›å¸¸ç”¨å·¥å…·ï¼ˆå¯é¸ï¼‰
RUN apk add --no-cache dumb-init bash postgresql-client openssh-client sshpass

# è¤‡è£½ runtime node_modules
COPY --from=deps /app/node_modules ./node_modules

# è¤‡è£½è¨­å®šæª”ã€ç¨‹å¼ç¢¼
COPY --from=builder /workspace/apps/api-gateway/config ./config
COPY --from=builder /workspace/apps/api-gateway/dist/main.js ./dist/main.js
COPY --from=builder /workspace/apps/api-gateway/dist/package*.json ./
COPY --from=builder /workspace/apps/api-gateway/scripts ./scripts

RUN chmod +x ./scripts/*.sh \
    && mkdir -p /app/uploads \
    && chown -R node:node /app/uploads

USER node

ENTRYPOINT ["/usr/bin/dumb-init", "--", "./scripts/entry.sh"]
