# ==== BUILD STAGE ====
FROM jamesshi/nx-base:staging AS builder

WORKDIR /workspace

# ğŸš« é—œé–‰ Nx daemonã€äº’å‹•æ¨¡å¼èˆ‡ spinner
ENV NX_DAEMON=false
ENV NX_SKIP_NX_CACHE=true
ENV CI=true
ENV NODE_OPTIONS="--max-old-space-size=4096"

# COPY . .

# RUN npm install

# # Optional: Only generate client for specific services
# RUN npx prisma generate --schema=libs/prisma/src/schema/data-management/schema.prisma

# Build specific app (business-service)
RUN npx nx build business-service

# # æ··æ·† ./dist -> ./dist-obf
# RUN npx javascript-obfuscator ./apps/business-service/dist --output ./apps/business-service/dist-obf \
#   --compact true \
#   --control-flow-flattening true \
#   --string-array true \
#   --string-array-encoding base64

# ==== RUNTIME DEPS STAGE ====
FROM jamesshi/nx-base:staging AS deps

WORKDIR /app

# å¾ builder è¤‡è£½ä¿®å‰ªå¾Œçš„ package.jsonï¼ˆNx prune æœƒè¼¸å‡ºåˆ° dist ä¸‹ï¼‰
COPY --from=builder /workspace/apps/business-service/dist/package*.json ./

# åªå®‰è£ runtime deps
RUN npm ci --omit=dev

# ==== FINAL RUNTIME STAGE ====
FROM node:22.17.1-alpine AS runner

WORKDIR /app

# å»ºè­°ä»ä¿ç•™ dumb-init / ssh / postgresql-client ç­‰
RUN apk add --no-cache dumb-init bash postgresql-client openssh-client sshpass

# è¤‡è£½ runtime node_modules
COPY --from=deps /app/node_modules ./node_modules

# Copy runtime dependencies
COPY --from=builder /workspace/apps/business-service/config ./config
COPY --from=builder /workspace/apps/business-service/dist/main.js ./dist/main.js
COPY --from=builder /workspace/apps/business-service/dist/package*.json ./
COPY --from=builder /workspace/apps/business-service/scripts ./scripts

RUN chmod +x ./scripts/*.sh

# ä½¿ç”¨ node user å•Ÿå‹•
USER node

# Entry
ENTRYPOINT ["/usr/bin/dumb-init", "--", "./scripts/entry.sh"]
